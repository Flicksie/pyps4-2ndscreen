#!/bin/bash
# Pushes a new version to PyPi. Run from root directory.
DEV_BRANCH="dev"
CURRENT="Already up to date."
ACCESS_TOKEN="$(git config --global github.token)"
repo_url="$(echo $(git config --get remote.origin.url) | grep -Po '.*(?=\.)')"
url="$(echo $repo_url | sed 's\'github.com'\'api.github.com/repos'\g')"
API_URL=$(printf "%s/releases" $url)

VERSION="$(python -m pyps4_2ndscreen.__version__)"

git checkout dev
git reset HEAD
branch="$(git status | head -n 1 | tail -c 4)"
if [[ $branch != $DEV_BRANCH ]];
then
	echo "Branch not on dev."
	exit 1
fi

git_pull="$(git pull)"
if [[ $git_pull != $CURRENT ]];
then
	echo "Branch not up to date."
	exit 1
fi

python3 setup.py install

echo "Running Media Art Tests"
test_result="$(script/test_art | head -c 7)"
echo $test_result
if [ $test_result != "Success" ];
then
	read -p "Media Art Test Failed: Continue?: y> " msg_test
	if [ "$msg_test" != "y" ];
	then
		git stash
		exit 1
	fi
fi

git commit -a -m "Update Media Art Test Logs"
git push

echo "Media Art Test Log committed"

rm -rf dist
rm -rf build
python3 setup.py sdist bdist_wheel
python3 -m twine check dist/*
python3 -m twine upload dist/* --skip-existing

git checkout master
git reset HEAD
git merge dev
git push

read -p "Enter release message: " msg

API_JSON="$(printf '{"tag_name": "%s","target_commitish": "master","name": "%s","body": "%s","draft": false,"prerelease": false}' "$VERSION" "$VERSION" "$msg")"
curl -H "Authorization: token $ACCESS_TOKEN" --data $API_JSON --url $API_URL
git checkout dev